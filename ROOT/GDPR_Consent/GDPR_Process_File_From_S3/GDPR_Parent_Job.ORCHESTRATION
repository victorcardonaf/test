{"job":{"components":{"877832":{"id":877832,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-820,"y":-188,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[877850],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"877833":{"id":877833,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-699,"y":-142,"width":32,"height":32,"inputConnectorIDs":[877850],"outputSuccessConnectorIDs":[877844],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"get configuration value for the process"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Udating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\npyvar_processname =processname\ncursor = context.cursor()\ncursor.execute(\"select src_url, src_folder, src_prefix, src_suffix, \"+\n\" des_url,des_folder,des_prefix, des_suffix ,archivefolderpath ,stagetablename ,stageoutboundtablename ,query , coalesce(endvalue,'0')\"+\n\" from etl_configuration \"+\n\" where processname = '%s' limit 1\" %pyvar_processname )\ndata =cursor.fetchone()\npyvar_src_url = data[0]\npyvar_src_folder = data[1]\npyvar_src_prefix = data[2]\npyvar_src_suffix = data[3]\npyvar_des_url = data[4]\npyvar_des_folder = data[5]\npyvar_des_prefix = data[6]\npyvar_des_suffix = data[7]\nprvar_arc_folder =data[8]\nprvar_stagetablename =data[9]\nprvar_stageoutboundtablename =data[10]\nprvar_query =data[11]\npylastvalue = int(data[12])\n\nprvar_arc_folder = prvar_arc_folder +'/'\n#prvar_arc_folder =pyvar_src_url+ '/'+prvar_arc_folder +'/'\n##pyvar_src_url = pyvar_src_url +'/'+pyvar_src_folder +'/'\npyvar_des_url = pyvar_des_url +'/'+pyvar_des_folder +'/'\n##print pyvar_src_url,pyvar_des_url\n##update environment\ncontext.updateVariable('processname',pyvar_processname )\ncontext.updateVariable('src_url',pyvar_src_url )\ncontext.updateVariable('src_folder',pyvar_src_folder )\ncontext.updateVariable('src_prefix', pyvar_src_prefix)\ncontext.updateVariable('src_suffix',pyvar_src_suffix )\ncontext.updateVariable('des_url',pyvar_des_url )\ncontext.updateVariable('des_folder',pyvar_des_folder )\ncontext.updateVariable('des_prefix',pyvar_des_prefix )\ncontext.updateVariable('des_suffix',pyvar_des_suffix )\ncontext.updateVariable('archivefolderpath',prvar_arc_folder )\ncontext.updateVariable('stagetablename',prvar_stagetablename )\ncontext.updateVariable('stageoutboundtablename',prvar_stageoutboundtablename )\ncontext.updateVariable('query',prvar_query )\ncontext.updateVariable('last_processed_file',pylastvalue )\ncontext.updateVariable('tablenameforfiles',('tmp_filename_' +pyvar_processname )  )\n\nprint data"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"877834":{"id":877834,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-293,"y":-82,"width":32,"height":32,"inputConnectorIDs":[877847],"outputSuccessConnectorIDs":[877846],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"get names of file to process"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import sys\nimport json\nimport boto3\nimport datetime\nimport calendar\nimport gzip\nfrom decimal import *\n\n\n\ncursor = context.cursor()\ns3 = boto3.client('s3')\ns3_resource = boto3.resource('s3')\nbucket = s3_resource.Bucket( src_url)\n                            \n\n\n\npy_current_file_name =''\npy_batchid ='0'\n\nlast_process_value =  last_processed_file\n\n#print src_prefix\n\nfor obj in bucket.objects.filter(Prefix=src_prefix):\n    obj_last_modified_ux = Decimal(calendar.timegm(obj.last_modified.utctimetuple()))\n    fname =str(obj.key)\n    if obj_last_modified_ux > last_process_value  : #and fname.startswith(src_prefix) == True\n      query =\"insert into loading.yourtable (filename ,fileid)  select  '%s' , \"  % fname  + str(obj_last_modified_ux)\n      query = query.replace('yourtable',tablenameforfiles)\n      cursor.execute(query)\n      #print fname,query\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"877835":{"id":877835,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":237373210,"x":-422,"y":-87,"width":32,"height":32,"inputConnectorIDs":[877845],"outputSuccessConnectorIDs":[877847],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate Stage Tables"}}}},"visible":true},"2":{"slot":2,"name":"Tables to Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${tablenameforfiles}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"${stagetablename}"}}}},"visible":true},"3":{"slot":3,"name":"Schema ","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"loading"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"877836":{"id":877836,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"ITERATE","implementationID":1227580116,"x":-90,"y":-107,"width":32,"height":16,"inputConnectorIDs":[877849],"outputSuccessConnectorIDs":[877848,877843],"outputFailureConnectorIDs":[877851],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Table Iterator 0"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${tablenameforfiles}"}}}},"visible":true},"3":{"slot":3,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"filename"},"2":{"slot":2,"type":"STRING","value":"filename"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"fileid"},"2":{"slot":2,"type":"STRING","value":"BatchId"}}}},"visible":true},"4":{"slot":4,"name":"Ordering","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fileid"}}}},"visible":true},"5":{"slot":5,"name":"Break on Failure","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"loading"}}}},"visible":true},"7":{"slot":7,"name":"Concurrency","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Sequential"}}}},"visible":true},"9":{"slot":9,"name":"Sort","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Ascending"}}}},"visible":true},"999":{"slot":999,"name":"Record Values In Task History","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[877852],"inputIterationConnectorIDs":[]},"877837":{"id":877837,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1785813072,"x":-260,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Message","mapTo":"message"},"2":{"slot":2,"fromId":null,"fromName":"Status","mapTo":"status"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"GDPR_Child_Job"}}}},"visible":true},"2":{"slot":2,"name":"Orchestration Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"GDPR_Child_Job"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[877852]},"877838":{"id":877838,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-90,"y":41,"width":32,"height":32,"inputConnectorIDs":[877848],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"send email"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import smtplib\n\nserver = smtplib.SMTP('mail.betgenius.com', 389)\nserver.starttls()\nemail = 'Makda.Haile@geniussports.com'\nserver.login(email, \"\")\n\nmsg = \"Testing email from Matillion !\"\nserver.sendmail(email, email, msg)\nserver.quit()\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 2"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"877839":{"id":877839,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":104,"y":-209,"width":32,"height":32,"inputConnectorIDs":[877851],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"update status error"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\t\ninsert into etl_inbound_log\n(processname, batchid, path, filename, rowcount, status, message)\nvalues ('${processname}','${BatchId}','${src_url}','${filename}',0,'${status}','${message}')\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"877840":{"id":877840,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":53,"y":-48,"width":32,"height":32,"inputConnectorIDs":[877843],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"update last process status"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"update  etl_configuration\nset endvalue =(select max(fileid) batchid from loading.${tablenameforfiles})\n,updatedate = getdate()\nwhere processname = '${processname}'"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"877841":{"id":877841,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-559,"y":-94,"width":32,"height":32,"inputConnectorIDs":[877844],"outputSuccessConnectorIDs":[877845],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create stage tables if does not exist"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--drop table if exists  loading.${tablenameforfiles};\n\nCREATE TABLE IF NOT EXISTS loading.${tablenameforfiles}\n(\"fileid\" BIGINT, \"filename\" VARCHAR(1000)) ;\n\n\ndrop table if exists loading.${stagetablename};\nCREATE TABLE IF NOT EXISTS  loading.${stagetablename}\n(\n\taccountid varchar(256),\n\tupdatedate timestamp,\n    --updatedate datetime,\n\tconsentprovided boolean,\n\tpurpose varchar(10000)\n);\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"877842":{"id":877842,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-282,"y":3,"width":32,"height":32,"inputConnectorIDs":[877846],"outputSuccessConnectorIDs":[877849],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"delete folder name from tmp table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"delete from loading.${tablenameforfiles}\nwhere filename in ('${src_prefix}' ,'${src_prefix}'+'/');"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"877849":{"id":877849,"sourceID":877842,"targetID":877836},"877848":{"id":877848,"sourceID":877836,"targetID":877838},"877845":{"id":877845,"sourceID":877841,"targetID":877835},"877844":{"id":877844,"sourceID":877833,"targetID":877841},"877847":{"id":877847,"sourceID":877835,"targetID":877834},"877846":{"id":877846,"sourceID":877834,"targetID":877842},"877843":{"id":877843,"sourceID":877836,"targetID":877840}},"failureConnectors":{"877851":{"id":877851,"sourceID":877836,"targetID":877839}},"unconditionalConnectors":{"877850":{"id":877850,"sourceID":877832,"targetID":877833}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{"877852":{"id":877852,"sourceID":877836,"targetID":877837}},"noteConnectors":{},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{},"variables":{"message":{"definition":{"name":"message","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":""},"status":{"definition":{"name":"status","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":""},"s3_bucket":{"definition":{"name":"s3_bucket","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"GDPR_Parent_Job","description":"","type":"ORCHESTRATION"}}